# SmartRGB Controller (STC8 Series)

## 项目简介
本项目是一个基于 STC8 系列单片机（STC8G/STC8H）的智能 LED 灯带控制器。
目前主要驱动 **66 颗 SM16703P/WS2811** 协议的 RGB 灯珠，实现了基于时间插值的平滑色彩渐变算法。

## 硬件规格

| 项目             | 参数                   | 备注                                |
| :--------------- | :--------------------- | :---------------------------------- |
| **MCU**          | STC8G1K08 / STC8H1K08  | 目前测试用 STC8G，最终目标 STC8H    |
| **封装**         | TSSOP20 / SOP8         |                                     |
| **主频**         | **24MHz**              | 必须精确匹配，影响驱动时序          |
| **LED 驱动芯片** | SM16703P (兼容 WS2811) | 归零码协议                          |
| **LED 数量**     | 66 颗                  | 显存占用约 200 Bytes                |
| **RAM 占用**     | ~910 Bytes (XDATA)     | 芯片总容量 1024 Bytes，**资源紧张** |

### 引脚定义 (可在 `config.h` 中修改)
* **LED 数据信号 (DI)**: `P1.3` (推挽输出)
* **板载指示灯**: `P1.0` (推挽输出)
* **调试/下载**: `P3.0 (RX)`, `P3.1 (TX)`

## 软件架构

### 文件说明
* `main.c`: 主程序入口，包含系统时钟计数、任务调度器 (Task Scheduler) 和顶层灯效状态机。
* `led_manager.c`: **核心逻辑层**。
    * 实现了 `SetLed` 接口。
    * 包含 **基于时间追帧的线性插值算法**，确保渐变时间准确，不随 CPU 负载变慢。
    * 管理双缓冲：`PixelBuffer`(当前显存), `StartBuffer`(渐变起点), `TargetBuffer`(渐变终点)。
* `ws2811_hal.c`: **硬件驱动层**。
    * 使用汇编级 `_nop_` 精确控制纳秒级时序。
    * 针对 SM16703P 时序优化 (0码~300ns, 1码~900ns)。
* `config.h`: 全局配置文件，包含引脚定义、时钟频率、数据类型重定义。

### 开发环境设置 (Keil C51)
**重要：** 由于使用了大量 Buffer，必须正确配置内存模式，否则编译报错或运行死机。
1.  **Target** -> **Memory Model**: 选择 `Large: variables in XDATA`.
2.  **Target** -> **Code Rom Size**: 选择 `Large: 64K program`.
3.  **Output**: 勾选 `Create HEX File`.

## API 使用说明

### 设置 LED 颜色 (带渐变)
```c
/**
 * @brief 设置某颗 LED 的颜色和渐变时间
 * @param index      LED 索引 (0 ~ 65)
 * @param r          红色 (0~255)
 * @param g          绿色 (0~255)
 * @param b          蓝色 (0~255)
 * @param brightness 亮度缩放 (0~1023, 1023为原色)
 * @param fade_ms    渐变时长 (ms)。例如 3000 代表 3秒内由当前色变到目标色
 */
void SetLed(uint8_t index, uint8_t r, uint8_t g, uint8_t b, uint16_t brightness, uint16_t fade_ms);


2026年1月22日 19点44分
灯效需求：
灯效需要更新下，按照如下方案设计:

上电后，流水时间10秒，流速慢一点，颜色不要这么鲜艳，亮度再调暗到当前一半的状态；

流水结束后白光常亮时间5秒；

常亮结束后再接着白光呼吸时间5秒；

然后再不停的反复循环

初次上电闪白光原因分析
1. 根本原因分析 (Root Cause)
现象解释：

冷启动闪白光：当系统第一次上电（24V接通 -> 5V LDO工作 -> MCU上电复位）时，单片机（STC8H）处于复位状态。在代码运行到 main() 函数之前，所有的GPIO口默认是高阻输入状态（Floating）。

原理图缺失：在你的原理图中，LED DATA 信号线（连接到 P1.2 或 P1.3）串联了一个电阻 R57 (470Ω)，但缺少一个下拉电阻（Pull-Down Resistor）。

后果：由于引脚悬空（高阻态），该引脚极易感应到环境杂波或由于漏电流被轻微拉高。SM16703P LED驱动芯片对数据脚非常敏感，上电瞬间如果 DIN 脚是高电平或有杂波，芯片内部的寄存器就会锁存为“全1”（即全白光）或者进入错误的测试模式。

为什么热启动（3秒内重连）没问题？

这是因为板子上的电容（原理图中的 C6, C7, C4 等）在断电后需要时间放电。

如果你在3秒内重新上电，MCU可能没有彻底掉电（Brown-out），或者LED驱动芯片内部的逻辑电压没有跌落到复位阈值以下。此时芯片里保存的还是“全黑”状态，或者MCU引脚电平尚未完全变成高阻态，所以不会闪烁。

2. 解决方案 (硬件修改 - 推荐)
软件延时（Delay）之所以无效，是因为闪烁发生在软件运行之前。要彻底解决，必须在硬件上给信号线一个确定的电平。

方案：加一颗下拉电阻

请在 PCB 板上进行如下飞线修改：

位置：在单片机的 LED控制引脚（即代码中的 P1.3 或原理图中的 LED DATA 网络）与 GND 之间。

阻值：焊上一颗 10kΩ 或 4.7kΩ 的电阻。

作用：这颗电阻会在单片机还在“睡觉”（复位/初始化）的时候，物理上强行把数据线拉低到 0V。这样 SM16703P 上电时看到的一定是低电平，就不会误动作闪白光了。